<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>13. Labores básicas de administración</title><meta name="generator" content="DocBook XSL Stylesheets V1.68.1"><link rel="start" href="index.html" title="Uso Básico de la distribución Aprendiendo de Jesús de OpenBSD"><link rel="up" href="index.html" title="Uso Básico de la distribución Aprendiendo de Jesús de OpenBSD"><link rel="prev" href="ar01s12.html" title="12. Correo electrónico"><link rel="next" href="novedades.html" title="A. Novedades"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">13. Labores básicas de administración</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s12.html">Anterior</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="novedades.html">Siguiente</a></td></tr></table><hr></div><div class="section" lang="es"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1658689168"></a>13. Labores básicas de administración</h2></div></div></div><p>
    Un sistema adJ se administra desde la cuenta <code class="literal">root</code>
    o bien con ayuda del programa <code class="literal">doas</code>.
  </p><p>
    Desde las diversas cuentas del sistema que estén en el grupo
    <code class="literal">wheel</code> es posible pasar a la cuenta root con la
    orden:
  </p><pre class="programlisting">
$ su -
</pre><p>
    Típicamente al pasar a la cuenta root el prompt cambiará a
    <code class="literal">#</code>.
  </p><p>
    Si <span class="strong"><strong>doas</strong></span> se configura para
    permitir su utilización por parte de usuarios que estén en el grupo
    <code class="literal">wheel</code> sin clave, podrán ejecutarse órdenes como
    si se tratara de la cuenta <code class="literal">root</code> precediéndolos
    con <span class="strong"><strong>doas</strong></span>. Por ejemplo para listar
    el directorio del usuario <code class="literal">root</code>:
  </p><pre class="programlisting">
$ doas ls /root
</pre><p>
    <span class="inlinemediaobject"><img src="img/warning.png"></span> Aviso: Toda acción que realice con el programa
    <span class="strong"><strong>doas</strong></span>, así como cambios de un
    usuario a otro, quedarán registradas en la bitácora
    <code class="literal">/var/log/secure</code>
  </p><div class="section" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="idm1658788880"></a>13.1. Manejo de usuarios</h3></div></div></div><p>
      Entre las labores del administrador está agregar, eliminar y
      modificar información de usuarios del sistema.
    </p><p>
      El administrador puede agregar usuarios con la orden
      <code class="literal">adduser</code>. Su uso típico se esboza a
      continuación<sup>[<a name="idm1658629136" href="#ftn.idm1658629136">16</a>]</sup>
    </p><pre class="programlisting">
doas adduser
...
Enter username []: juan
Enter full name []: Juan Valdez
Enter shell csh ksh nologin sh [ksh]: 
Uid [1003]: 
Login group juan [juan]: 
Login group is ``juan''. Invite juan into other groups: guest no 
[no]: wheel
Login class auth-defaults auth-ftp-defaults daemon default staff 
[default]: staff
Enter password []: 
Enter password again []: 

Name:        juan
Password:    ****
Fullname:    Juan Valdez
Uid:         1003
Gid:         1003 (juan)
Groups:      juan wheel
Login Class: staff
HOME:        /home/juan
Shell:       /bin/ksh
OK? (y/n) [y]: 
</pre><p>
      Note que todo usuario del sistema tiene:
    </p><div class="variablelist"><dl><dt><span class="term">
          Una identificación
        </span></dt><dd><p>
            juan en el ejemplo recién presentado
          </p></dd><dt><span class="term">
          Un UID
        </span></dt><dd><p>
            Se trata de un número que lo identifica (1003 en el ejemplo)
          </p></dd><dt><span class="term">
          Un GID
        </span></dt><dd><p>
            O número que identifica al grupo principal al que pertenece
            el usuario (1003 en el ejemplo).
          </p></dd><dt><span class="term">
          Un intérprete de órdenes
        </span></dt><dd><p>
            Que será el que tendrá el usuario al iniciar nuevas sesiones
            (en el ejemplo es /bin/ksh).
          </p></dd><dt><span class="term">
          Una clase de login
        </span></dt><dd><p>
            Que establecerá parámetros para la sesión, por ejemplo
            límite en el uso de memoria y recursos. En el ejemplo es
            <code class="literal">staff</code>, pero para usuarios que no vayan a
            administrar el sistema se sugiere <code class="literal">default</code>
          </p></dd><dt><span class="term">
          Eventualmente uno o más grupos secundarios
        </span></dt><dd><p>
            Cada usuario fuera de su grupo principal puede pertenecer a
            otros grupos. En este ejemplo, el usuario pertenecerá además
            al grupo <code class="literal">wheel</code>, lo cual indica que hará
            labores administrativas.
          </p></dd><dt><span class="term">
          Un directorio personal
        </span></dt><dd><p>
            Cuyo propietario será el usuario y quedará como directorio
            de trabajo cada vez que inicie una sesión. En el ejemplo es
            <code class="literal">/home/juan</code> (note que de manera
            predeterminada los directorios de usuarios son
            subdirectorios de <code class="literal">/home</code>).
          </p></dd></dl></div><p>
      Para eliminar un usuario y su directorio personal:
    </p><pre class="programlisting">
doas userdel -r juan
</pre><p>
      Es posible modificar información de los usuarios de diversas
      formas:
    </p><div class="itemizedlist"><ul type="disc"><li><p>
          Con la orden <code class="literal">vipw</code> que le permitirá
          modificar directamente el archivo de claves y usuarios
        </p></li><li><p>
          Con la orden <code class="literal">chfn usuario</code> podrá modificar
          algunos datos del perfil del usuario.
        </p></li></ul></div></div><div class="section" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="idm1658803728"></a>13.2. Bitácoras</h3></div></div></div><p>
      Una de las labores típicas de un administrador de un sistema adJ
      es revisar bitácoras del sistema en búsqueda de vulneraciones de
      seguridad. En la mayoría de las veces se trata de ataques a través
      de internet, ataques que buscan entre otras cosas: acceder a
      servidores para sacar información y modificarla, o usar servidores
      para que realicen trabajos que el atacante quiere hacer,
      generalmente maliciosos.
    </p><p>
      adJ/OpenBSD deja un registro muy completo en archivos de
      <code class="literal">/var/log</code> conocidos como bitácoras. Algunos son:
    </p><div class="itemizedlist"><ul type="disc"><li><p>
          <code class="literal">authlog</code>: Muestra los accesos de los
          usuarios permitidos y rechazados
        </p></li><li><p>
          <code class="literal">secure</code>: Muestra las órdenes ejecutadas por
          administradores
        </p></li><li><p>
          <code class="literal">servicio</code>: Los programas que están corriendo
          en la máquina
        </p></li></ul></div><p>
      Como el sistema hace rotación de bitácoras periódicamente, en el
      mismo directorio también se encuentra archivadas algunas bitácoras
      recientes, comprimidas (terminan con nombres como
      .<code class="literal">0.gz</code>).
    </p><div class="section" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="idp264469104"></a>13.2.1. Análisis simple con la herramienta
      <code class="literal">auditabitacoras</code> y reportar una IP</h4></div></div></div><p>
        adJ incluye un sencillo analizador de bitácoras que se inicia
        con:
      </p><pre class="programlisting">
    doas auditabitacoras
</pre><p>
        Que creará un directorio con copia de las bitácoras y el informe
        del análisis. El nombre del directorio será la fecha de
        ejecución y se ubicará en
        <code class="literal">/var/adJ/auditabiracoras</code>
      </p><p>
        Por ejemplo si la fecha es 2017-06-27 el reporte quedará en
        <code class="literal">/var/adJ/auditabitacoras/20170627/auditabitacoras.txt</code>
      </p><div class="literallayout"><p>Se trata de un análisis a los archivos con prefijo <code class="literal">/var/log/auth</code> (que junto con otras bitácoras quedarán copiadas en el directorio creado).<br>
Debe prestar especial atención a posibles ataques dirigidos a un usuario real del cortafuegos (o de la red) para reportar y bloquear.</p></div><p>
        La IP que esté haciendo más ataques a cuentas genéricas (e.g
        root) reportarla por ejemplo en
        <a href="">https://www.abuseipdb.com</a>
        en las categorías ssh y ataque de fuerza bruta.
      </p><p>
        Tal IP se puede bloquear agregando en el archivo
        <code class="literal">/etc/pf.conf</code> al final unas líneas del estilo:
      </p><pre class="programlisting">
    # IP de China reportada el 28 de Junio en https://www.abuseipdb.com/check/58.218.198.142
    block quick on egress from 58.218.198.142
</pre></div><div class="section" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="idp264621680"></a>13.2.2. Ejemplo de análisis usando herramientas UNIX</h4></div></div></div><p>
        Estos archivos pueden analizarse con algunas herramientas
        básicas como:
      </p><pre class="programlisting">
: Examinar una archivo. En ```less``` la tecla ```G``` (mayúscula) lo lleva al 
    final del archivo.

```grep```
: Muestra cadenas en un archivo

```find```
: Busca una cadena en un archivo o directorio

```wc```
: Cuenta palabras/líneas/caracteres en una archivo

```dig```
: Muestra información de un dominio

```geoiplookup```
: Muestra localización de una IP. No es muy precisa

```gzip```
: Descomprime archivos

A continuación un ejemplo de auditoría de la bitácora ```auth```:

  1. Como usuario root hacer una copia de las bitácoras de ```/var/log``` 
    en un directorio personal y descomprimir bitácoras comprimidas.
</pre><p>
        cd mkdir audita # Crea un directorio para copiar cd audita #
        Pasa al directorio creado mkdir 30sep2006 # Crear un directorio
        con la fecha cd 30sep2006 # Pasa al directorio creado cp -rf
        /var/log/* . # Copia todas las bitácoras (debe ser root) gzip -d
        *.gz # Descomprime bitácoras comprimidas
      </p><pre class="programlisting">
            
  2. Revisar la bitácora a fin de determinar puntos críticos:
</pre><p>
        less authlog
      </p><pre class="programlisting">
    buscando líneas como
</pre><p>
        invalid user test from 211.157.113.89
      </p><pre class="programlisting">
    que revelan intento desde una IP por ingresar como usuario ```test```
    (que no existe en el sistema).

  3. Para ver las líneas en las que aparece una cadena en especial, una 
    IP por ejemplo puede usarse:
</pre><p>
        grep “<span class="quote">211.157.113.89</span>” authlog
      </p><pre class="programlisting">
    De forma que podemos ver datos importantes relacionados con la IP 
    como fecha y hora. En el caso de auth la IP corresponde a direcciones 
    desde donde se hacen intentos de ingreso).

  4. Para mostrar cuántas veces está esa IP en ese archivo:
</pre><p>
        grep “<span class="quote">211.157.113.89</span>” authlog | wc -l
      </p><pre class="programlisting">
            
  5. Para determinar en qué archivos de la bitácora hay información de esta 
    IP
</pre><p>
        find . -exec grep -l “<span class="quote">211.157.113.89</span>” {}
        “<span class="quote">;</span>”
      </p><pre class="programlisting">
            
  6. Para determinar ubicación geográfica de una IP y datos sobre el dominio 
    asociado:
</pre><p>
        geoiplookup 211.157.113.89 dig -x 211.157.113.89
      </p><pre class="programlisting">
            
    El primero indica China, el segundo mail.chinacomm.com.cn. Con el 
    segundo ya podemos buscar información sobre el registro DNS de 
    chinacomm.com.cn:
</pre><p>
        whois chinacomm.com.cn
      </p><pre class="programlisting">
    donde encontramos una dirección de correo: ```wjy@chncomm.com```

  7. Si se ubica el dominio de la IP de donde proviene un ataque, así como una 
    dirección de correo, se recomienda enviar un mensaje en inglés a tal 
    dirección y/o por ejemplo a las cuentas webmaster y root informando 
    sobre el incidente con un tema como:
</pre><p>
        Attempt to login at practica.pasosdeJesus.org from your IP on
        16.Aug.2006 at 7:10:41
      </p><pre class="programlisting">
            
### Lecturas recomendadas {#lecturas_recomendadas_admin}

- Documentación del sistema **man adduser, man userdel**

- Para instalar y comenzar a administrar un sistema adJ 
  sugerimos [usuario_adJ](#bibliografia).

- Para administrar un servidor adJ conectado a Internet recomendamos 
  [servidor_adJ](#bibliografia)

Todas las herramientas mencionadas **less**, **find**, **grep**, **wc** tienen 
sus respectivos manuales, los cuales se pueden consultar con **man**, 
por ejemplo
</pre><p>
        man grep ```
      </p></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p xmlns="http://www.w3.org/TR/xhtml1/transitional"><sup>[<a name="ftn.idm1658629136" href="#idm1658629136">16</a>] </sup>
          Tenga en cuenta que la primera vez que ejecute
          <code xmlns="" class="literal">adduser</code> tras instalar un sistema adJ, este
          programa preguntará valores predeterminados por emplear
          durante la creación de cuentas.
        </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s12.html">Anterior</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="novedades.html">Siguiente</a></td></tr><tr><td width="40%" align="left" valign="top">12. Correo electrónico </td><td width="20%" align="center"><a accesskey="h" href="index.html">Inicio</a></td><td width="40%" align="right" valign="top"> A. Novedades</td></tr></table></div></body></html>
